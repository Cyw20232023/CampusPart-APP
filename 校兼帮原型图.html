<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>CampusJobs - 完整原型（学生/雇主完全切割 + 审核工作流）</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
  /* ====== 手机外框 ====== */
  body {
    margin: 0;
    font-family: Inter, "Helvetica Neue", Arial, sans-serif;
    background: #e6eef5;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    height: 100vh;
    overflow: hidden; /* 禁止body滚动 */
  }
  .device {
    width: 420px;
    max-width: calc(100% - 32px);
    margin: 24px auto;
    border-radius: 36px;
    padding: 12px;
    background: linear-gradient(180deg,#fbfdff,#f3fbfa);
    box-shadow: 0 18px 40px rgba(8,12,30,0.12);
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border: 10px solid #15151510;
    min-height: 700px;
    max-height: 800px; /* 固定最大高度为首页内容高度 */
    height: 800px;     /* 固定高度为首页内容高度（如需微调可调整此值）*/
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  /* notch */
  .device:before{ content:""; position:absolute; left:50%; transform:translateX(-50%); top:-8px; width:180px; height:26px; border-radius:14px; background:#fff3; box-shadow: inset 0 1px 0 rgba(255,255,255,.6); }
  /* ====== 头部 ====== */
  header{height:56px;background:#fff;border-radius:18px;padding:8px 12px;display:flex;align-items:center;gap:12px;border:1px solid #eef3f6}
  .brand{font-weight:900;color:#0ea5a4}
  .searchbar{flex:1;display:flex;background:#fbfffe;padding:8px;border-radius:10px;border:1px solid #ecf6f6}
  .searchbar input{border:0;background:transparent;outline:none;padding:0 8px}
  .roleBtn{padding:6px 10px;border-radius:10px;border:1px solid #eef3f6;font-size:13px;cursor:pointer}
  main#main {
    flex: 1 1 auto;
    overflow-y: auto;
    padding-bottom: 100px;
    min-height: 0;
    max-height: 100%;
  }
  /* ====== 卡片/按钮 ====== */
  .card{background:#fff;border-radius:14px;padding:12px;border:1px solid #eef6f5;box-shadow:0 6px 18px rgba(10,20,30,0.04);margin-bottom:12px}
  .title{font-weight:800;font-size:18px}
  .muted{color:#718096;font-size:13px}
  .row{display:flex;gap:10px;align-items:center}
  .col{display:flex;flex-direction:column;gap:8px}
  .chip{background:#f0fffb;border-radius:999px;padding:6px 10px;color:#048f8a;border:1px solid #dff3f1;font-weight:700;font-size:13px}
  .salary{color:#0ea5a4;font-weight:800}
  .btn{background:#0ea5a4;color:#fff;padding:10px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:800}
  .btn.secondary{background:#fff;color:#334155;border:1px solid #e6eef0}
  .btn.small{padding:8px 10px;border-radius:10px}
  .divider{height:1px;background:#eef6f6;margin:12px 0;border-radius:4px}
  /* ====== page transition ====== */
  .view{position:relative;transition:transform .36s cubic-bezier(.22,.9,.32,1),opacity .24s;will-change:transform,opacity}
  .hidden{display:none !important}
  /* ====== bottom nav ====== */
  nav.bottom{
    position:absolute; /* 从 fixed 改为 absolute，始终在.device内部 */
    left:0;
    bottom:20px;
    width:100%;
    max-width:100%;
    background:#fff;
    padding:8px;
    border-radius:22px;
    border:1px solid #eef6f5;
    display:flex;
    gap:10px;
    z-index:80;
    justify-content:space-around;
    box-sizing:border-box;
  }
  nav.bottom .tab{padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:800;color:#718096}
  nav.bottom .tab.active{background:linear-gradient(90deg,#0ea5a4,#38bfb9);color:#fff;box-shadow:0 8px 24px rgba(6,182,164,0.12)}
  /* ====== job card ====== */
  .job{padding:12px;border-radius:12px;border:1px solid #eef6f5;background:linear-gradient(180deg,#fff,#fbfffe);cursor:pointer;transition:transform .18s}
  .job:hover{transform:translateY(-4px)}
  .job h3{margin:0}
  .meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  /* ====== chat ====== */
  .chat-window{display:flex;flex-direction:column;gap:8px;height:58vh}
  .messages{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
  .msg{max-width:72%;padding:8px 12px;border-radius:12px;display:inline-block;font-size:14px}
  .msg.me{align-self:flex-end;background:linear-gradient(180deg,#d9f1ff,#bfe9ff);border:1px solid #cfeeff}
  .msg.other{align-self:flex-start;background:#f3f6fb;border:1px solid #e8eef6}
  .msg.system{align-self:center;background:transparent;color:#64748b;font-size:12px}
  .time{font-size:11px;color:#94a3b8;margin-top:4px}
  .input-row{display:flex;gap:8px;padding:8px;border-top:1px solid #eef6f5}
  .input-row input{flex:1;padding:10px;border-radius:10px;border:1px solid #eef6f5}
  /* ====== resume preview box ====== */
  .resumeBox{padding:10px;border:1px dashed #e6f7f5;border-radius:10px;background:#fbfffe}
  .resumePreview{max-height:300px;overflow:auto;border-radius:8px;border:1px solid #eef6f5;padding:8px}
  .app-footer-note{font-size:12px;color:#94a3b8;text-align:center;margin-top:6px}
  /* ====== small UI ====== */
  .badge{background:#0ea5a4;color:#fff;padding:6px 8px;border-radius:8px;font-weight:800;font-size:13px}
  .avatar{width:56px;height:56px;border-radius:999px;background:#e6fbf9;display:flex;align-items:center;justify-content:center;color:#066d69;font-weight:900}
  .skill{padding:6px 10px;border-radius:999px;background:#fff;border:1px solid #eef6f5;font-weight:800;color:#334155}
  .mutedSmall{font-size:12px;color:#94a3b8}
  
  /* 登录标签样式 */
  .login-tab.active {
    background: #0ea5a4 !important;
    color: white !important;
    font-weight: 600;
  }
  
  .login-tab:hover {
    background: #e6f7f5 !important;
  }
  
  .btn.third-party:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }
  
  /* 验证码按钮样式 */
  #btnSendSms:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  /* responsive */
  @media (max-width:440px){
    .device{width:100%;margin:12px; min-height: 600px; max-height: 98vh; height: 98vh;}
    nav.bottom{max-width:100%;}
    
    .login-tab {
      font-size: 13px !important;
      padding: 8px !important;
    }
    
    .btn.third-party {
      font-size: 13px !important;
      padding: 8px 12px !important;
    }
  }
</style>
</head>
<body>

<div class="device" id="device">
  <header>
    <div style="width:8px"></div>
    <div class="brand">校兼帮</div>
    <div class="searchbar" id="searchbar"><input id="q" placeholder="搜索岗位 / 关键字（如：家教）" /></div>
    <div class="roleBtn" id="roleBtn" title="切换角色">学生端</div>
  </header>

  <main id="main" style="padding:12px;">

    <!-- 登录视图 - 优化版 -->
    <section id="view-login" class="view">
      <div class="card" style="max-width: 400px; margin: 40px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-radius: 16px;">
        <div style="text-align: center; margin-bottom: 24px;">
          <div class="title" style="font-size: 24px; color: #1e293b; margin-bottom: 8px;">登录校兼帮</div>
          <div class="muted" style="font-size: 14px; color: #64748b;">校园兼职，直接沟通，快速上岗</div>
        </div>
        
        <!-- 登录方式切换 -->
        <div style="margin-bottom: 20px; display: flex; gap: 12px;">
          <button id="tabPassword" class="login-tab active" style="flex:1; padding:10px; border:none; background:#f1f5f9; border-radius:8px; font-size:14px; cursor:pointer;">密码登录</button>
          <button id="tabSms" class="login-tab" style="flex:1; padding:10px; border:none; background:#f1f5f9; border-radius:8px; font-size:14px; cursor:pointer;">验证码登录</button>
        </div>
        
        <!-- 密码登录表单 -->
        <div id="passwordForm" style="margin-bottom: 20px;">
          <input id="loginUser" placeholder="手机号 / 用户名" style="padding: 14px; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 16px; width: 100%; box-sizing: border-box; margin-bottom: 12px;" />
          <input id="loginPass" type="password" placeholder="密码" style="padding: 14px; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 16px; width: 100%; box-sizing: border-box; margin-bottom: 12px;" />
          <div style="display: flex; align-items: center; margin-bottom: 12px;">
            <input type="checkbox" id="rememberMe" style="margin-right: 8px;">
            <label for="rememberMe" style="font-size: 14px; color: #64748b;">记住密码</label>
          </div>
        </div>
        
        <!-- 验证码登录表单 -->
        <div id="smsForm" style="margin-bottom: 20px; display: none;">
          <input id="loginPhone" placeholder="手机号" style="padding: 14px; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 16px; width: 100%; box-sizing: border-box; margin-bottom: 12px;" />
          <div style="display: flex; gap: 8px; margin-bottom: 12px;">
            <input id="loginSms" placeholder="验证码" style="flex:1; padding: 14px; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 16px; box-sizing: border-box;" />
            <button id="btnSendSms" class="btn secondary" style="padding: 14px 16px; border-radius: 8px; font-size: 14px; white-space: nowrap;">获取验证码</button>
          </div>
        </div>
        
        <div style="margin-bottom: 20px; text-align: center;">
          <div class="muted" style="font-size: 12px; color: #94a3b8;">示例账号：小明（学生） / 小红（雇主）</div>
          <div class="muted" style="font-size: 12px; color: #94a3b8; margin-top: 4px;">密码可输入任意内容</div>
        </div>
        
        <select id="loginRole" style="padding: 14px; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 16px; width: 100%; box-sizing: border-box; background-color: #fff; margin-bottom: 20px;" onchange="handleRoleChange()">
          <option value="">请选择身份</option>
          <option value="student">学生</option>
          <option value="recruiter">雇主</option>
        </select>
        
        <button class="btn" id="btnLogin" style="width: 100%; padding: 14px; font-size: 16px; font-weight: 600; border-radius: 8px; background: #0ea5a4; border: none; margin-bottom: 16px;">立即登录</button>
        
        <div style="margin-top: 16px; text-align: right;">
          <a href="#" style="font-size: 12px; color: #0ea5a4; text-decoration: none;">忘记密码？</a>
          <span style="color: #e2e8f0; margin: 0 8px;">|</span>
          <a href="#" style="font-size: 12px; color: #0ea5a4; text-decoration: none;">立即注册</a>
        </div>
        
        <div style="margin: 20px 0; text-align: center; position: relative;">
          <div style="height: 1px; background: #e2e8f0;"></div>
          <div style="position: absolute; top: -8px; left: 50%; transform: translateX(-50%); background: white; padding: 0 12px; color: #64748b; font-size: 12px;">或</div>
        </div>
        

        
        <div style="margin: 24px 0; text-align: center;">
          <div style="font-size: 12px; color: #64748b; margin-bottom: 12px;">第三方登录</div>
          <div style="display: flex; justify-content: center; gap: 12px;">
            <button class="btn third-party" style="padding: 10px 16px; border-radius: 8px; background: #07c160; color: white; border: none; font-size: 14px; flex:1;">
              <i class="fa-brands fa-weixin" style="margin-right: 6px;"></i>微信
            </button>
            <button class="btn third-party" style="padding: 10px 16px; border-radius: 8px; background: #12b7f5; color: white; border: none; font-size: 14px; flex:1;">
              <i class="fa-brands fa-qq" style="margin-right: 6px;"></i>QQ
            </button>
            <button class="btn third-party" style="padding: 10px 16px; border-radius: 8px; background: #dd4b39; color: white; border: none; font-size: 14px; flex:1;">
              <i class="fa-solid fa-mobile" style="margin-right: 6px;"></i>手机
            </button>
          </div>
        </div>
        

      </div>
    </section>

    <!-- 首页（学生） -->
    <section id="view-home" class="view hidden">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="title">为你推荐</div>
          <div class="muted">直接沟通、快速报名 — Boss直聘式体验</div>
        </div>
        <div style="text-align:right">
          <div class="muted">角色</div>
          <div style="height:6px"></div>
          <div id="roleTag" class="badge">学生</div>
        </div>
      </div>

      <!-- Skills quick -->
      <div class="card" id="studentTop">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">技能认证</div>
            <div class="title" style="font-size:16px">完善技能并上传凭证，可提升匹配优先级</div>
          </div>
          <div><button class="btn small" id="goSkills">去认证</button></div>
        </div>
        <div class="divider"></div>
        <div id="skillList" style="display:flex;gap:8px;flex-wrap:wrap"></div>
      </div>

      <div class="card row" style="align-items:center">
        <div class="chip" data-fast="近校">近校</div>
        <div class="chip" data-fast="高薪">高薪</div>
        <div class="chip" data-fast="可日结">可日结</div>
        <div class="chip" data-fast="包餐">包餐</div>
        <div style="margin-left:auto"><select id="typeFilter" style="padding:8px;border-radius:8px;border:1px solid #eef6f5"><option value="">全部类型</option><option>家教</option><option>促销</option><option>助理</option><option>活动</option></select></div>
      </div>

      <div id="jobList" class="grid" style="margin-top:12px"></div>

      <div class="card">
        <div style="font-weight:700">平台意义</div>
        <div class="muted" style="margin-top:6px">本平台不仅提供校园兼职岗位，还通过保证金与雇主信用机制保障学生权益，并通过技能认证与简历提升岗位匹配精度，促进校园实践与就业成长。</div>
      </div>
    </section>

    <!-- Recruiter Dashboard -->
    <section id="view-recruit" class="view hidden">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="title">招聘管理</div>
          <div class="muted">发布岗位与审核报名 / 简历 / 技能</div>
        </div>
        <div><button class="btn small" id="btnNewPost">+ 发布岗位</button></div>
      </div>

      <div id="recruitList" style="margin-top:12px"></div>

      <div style="height:12px"></div>
      <!-- Review queue -->
      <div class="card">
        <div class="title" style="font-size:15px">审核中心</div>
        <div class="mutedSmall" style="margin-top:6px">处理学生提交的技能与简历申请</div>
        <div id="reviewQueue" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- Job detail -->
    <section id="view-job" class="view hidden">
      <div id="jobDetailWrap"></div>
      <div style="height:12px"></div>
      <div class="card row" style="position:sticky;bottom:96px;align-items:center">
        <button id="jobChat" class="btn secondary" style="flex:1">沟通</button>
        <div style="width:8px"></div>
        <button id="jobApply" class="btn" style="flex:1">报名 / 申请</button>
      </div>
    </section>

    <!-- Post (recruiter) -->
    <section id="view-post" class="view hidden">
      <div class="card">
        <div class="title">发布岗位</div>
        <div class="muted">填写岗位信息并支付保证金（模拟）</div>
        <div style="height:8px"></div>
        <div class="col">
          <input id="p_title" placeholder="岗位名称（如：家教 - 高数）" />
          <select id="p_type"><option>家教</option><option>促销</option><option>助理</option><option>活动</option></select>
          <input id="p_pay" type="number" placeholder="薪资（¥）" />
          <input id="p_time" placeholder="时间（如：周末 9:00-17:00）" />
          <input id="p_loc" placeholder="地点（如：东区图书馆）" />
          <textarea id="p_desc" rows="3" placeholder="岗位描述 / 要求 / 福利"></textarea>
          <input id="p_contact" placeholder="联系人 / 电话 / 微信" />
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="muted">保证金： <b id="depositShow">¥0</b></div>
            <div><button class="btn small" id="calcDepositBtn">计算保证金</button></div>
          </div>
          <div style="height:8px"></div>
          <div class="row">
            <button class="btn" id="submitPost">支付保证金并发布</button>
            <div style="width:8px"></div>
            <button class="btn secondary" id="cancelPost">取消</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Chat -->
    <section id="view-chat" class="view hidden">
      <div class="card chat-window">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="title" id="chatTitle">沟通</div>
            <div class="muted" id="chatSub">联系人信息</div>
          </div>
          <div><button class="btn small" id="endChat">关闭</button></div>
        </div>
        <div class="divider"></div>
        <div id="messages" class="messages"></div>
        <div class="input-row">
          <input id="chatInput" placeholder="请输入消息..." />
          <button id="sendMsg" class="btn small">发送</button>
        </div>
      </div>
    </section>

    <!-- Skills / student -->
    <section id="view-skills" class="view hidden">
      <div class="card">
        <div class="title">技能认证</div>
        <div class="muted">上传凭证或填写技能，帮助平台审核并在简历中高亮</div>
        <div style="height:8px"></div>
        <input id="skillName" placeholder="技能名称（如：Photoshop / 英语六级）" />
        <select id="skillLevel"><option>初级</option><option>中级</option><option>高级</option></select>
        <input id="skillFile" type="file" accept="image/*,application/pdf" />
        <div style="height:8px"></div>
        <div class="row">
          <button class="btn" id="addSkill">提交认证</button>
          <div style="width:8px"></div>
          <button class="btn secondary" id="cancelSkill">取消</button>
        </div>
      </div>

      <div style="height:12px"></div>
      <div class="card">
        <div class="title">我的技能</div>
        <div id="mySkills" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap"></div>
      </div>
    </section>

    <!-- My profile & resume -->
    <section id="view-my" class="view hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:12px;align-items:center">
            <div class="avatar" id="avatar">小</div>
            <div>
              <div style="font-weight:800" id="profileName">小明</div>
              <div class="muted" id="profileSchool">广西大学</div>
            </div>
          </div>
          <div style="text-align:right">
          <div class="muted">角色</div>
          <div style="height:6px"></div>
          <div id="myRole" class="badge">学生</div>
          <div style="height:8px"></div>
          <button class="btn secondary small" onclick="logout()">退出登录</button>
          <div style="height:8px"></div>
          <button class="btn warning small" onclick="resetLoginState()" style="display:none;">重置登录状态</button>
        </div>
        </div>

        <div class="divider"></div>
        <div class="title" style="font-size:15px">简历 (可上传)</div>
        <div class="muted">支持 PDF / 图片 / 其他</div>
        <div style="height:8px"></div>
        <div class="resumeBox">
          <input id="resumeUpload" type="file" accept=".pdf,image/*,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
          <div id="resumeInfo" style="display:flex;justify-content:space-between;align-items:center">
            <div class="muted" id="resumeName">未上传简历</div>
            <div>
              <button class="btn small" id="viewResumeBtn" disabled>预览</button>
              <button class="btn secondary small" id="delResumeBtn" disabled>删除</button>
            </div>
          </div>
          <div id="resumePreviewWrap" class="resumePreview hidden" style="margin-top:8px"></div>
        </div>
      </div>

      <div style="height:12px"></div>
  <div class="card">
    <div class="title">我的报名 / 发布</div>
    <div id="myRecords"></div>
  </div>

  <!-- 新增：消息中心入口 -->
  <div style="height:12px"></div>
  <div class="card">
    <div class="title">消息中心</div>
    <div class="muted" style="margin-bottom:12px">查看所有沟通消息和系统通知</div>
    <button class="btn" onclick="show('chat')" style="width:100%">查看消息</button>
  </div>
    </section>

  </main>

  <!-- bottom nav (will be customized per role) -->
  <nav class="bottom">
    <!-- tabs inserted dynamically -->
  </nav>

  <div class="app-footer-note mutedSmall" style="text-align:center;padding:8px 0">演示数据保存在浏览器 localStorage，中途刷新会保留状态。</div>
</div>

<!-- modal -->
<div id="modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:300;background:rgba(0,0,0,0.36)">
  <div style="width:92%;max-width:420px;background:#fff;padding:14px;border-radius:14px;border:1px solid #eef6f5;transform:translateY(20px);opacity:0;transition:all .22s" id="modalBox">
    <div class="title" id="modalTitle">提示</div>
    <div class="muted" id="modalBody" style="margin-top:8px"></div>
    <div style="height:12px"></div>
    <div style="display:flex;gap:8px">
      <button class="btn" id="modalConfirm">确认</button>
      <button class="btn secondary" id="modalCancel">取消</button>
    </div>
  </div>
</div>

<script>
/* ================== 数据键与工具函数 ================== */
const APP = {
  jobsKey: 'cj_jobs_v3',
  userKey: 'cj_user_v3',
  appliedKey: 'cj_applied_v3',
  skillsKey: 'cj_skills_v3',
  chatsKey: 'cj_chats_v3',
  resumesKey: 'cj_resumes_v3'
};
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const uid = ()=> Math.random().toString(36).slice(2,9);
const now = ()=> Date.now();

function storageGet(k, def=null){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):def; }catch(e){return def} }
function storageSet(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

/* ================ 初始化示例数据 ================ */
function initSeed(){
  if(storageGet(APP.jobsKey)) return;
  // 5 sample jobs
  const jobs = [
    {id:'J-A1', title:'高等数学一对一家教', type:'家教', pay:200, time:'周二/周四 19:00-21:00', loc:'东区图书馆', daily:'否', desc:'辅导高等数学，需熟悉教材与习题解析。', contact:'王老师 18800001111', flags:['近校'], owner:'学校-数学系', deposit: Math.max(50, Math.round(200*0.05)), created: now()-86400*1000*5},
    {id:'J-A2', title:'商场新品促销员', type:'促销', pay:300, time:'本周六 10:00-18:00', loc:'XX购物中心', daily:'是', desc:'负责导购与陈列，提供午餐。', contact:'张经理 13900002222', flags:['高薪','包餐','今日可上岗'], owner:'外包-商贸', deposit: Math.max(50, Math.round(300*0.05)), created: now()-86400*1000*3},
    {id:'J-A3', title:'学院论坛会务助理', type:'助理', pay:150, time:'周五 13:00-17:00', loc:'报告厅A101', daily:'否', desc:'负责签到、引导、物料管理，需有耐心。', contact:'学生会 李', flags:['近校'], owner:'学生会', deposit: Math.max(50, Math.round(150*0.05)), created: now()-86400*2},
    {id:'J-A4', title:'运动会志愿者', type:'活动', pay:100, time:'周末 全天', loc:'体育场', daily:'否', desc:'维持秩序、物资分发，提供简餐。', contact:'体委', flags:['近校','包餐'], owner:'学校-体委', deposit: Math.max(50, Math.round(100*0.05)), created: now()-86400},
    {id:'J-A5', title:'软件测试兼职（远程）', type:'助理', pay:80, time:'灵活', loc:'远程', daily:'否', desc:'负责 APP 测试、BUG 反馈，每周任务制。', contact:'李工程师 13700003333', flags:['远程'], owner:'外包-IT', deposit: Math.max(50, Math.round(80*0.05)), created: now()-3600*5}
  ];
  // skills with owner attribute
  const skills = [
    {id:'SK1', owner:'小明', name:'Excel 高级', level:'高级', status:'已认证'},
    {id:'SK2', owner:'小明', name:'英语六级', level:'中级', status:'已认证'},
    {id:'SK3', owner:'学生A', name:'Photoshop', level:'中级', status:'待审核'},
    {id:'SK4', owner:'学生B', name:'活动策划', level:'中级', status:'待审核'}
  ];
  // chats: jobId -> messages (sender: name or '系统')
  const chats = {
    'J-A1': [
      {sender:'王老师', text:'你好，请问有辅导经验吗？', time: now()-86400*3},
      {sender:'小明', text:'有的，曾在补习班任教，能提供试讲。', time: now()-86400*3 + 3600}
    ],
    'J-A2': [
      {sender:'张经理', text:'我们周六需要3位促销员，提供午餐，是否能来？', time: now()-86400*2},
      {sender:'小明', text:'可以，请问几点集合？', time: now()-86400*2 + 1800}
    ]
  };
  // applied mapping jobId -> list of applicant objects
  const applied = {
    'J-A1': [
      {name:'小明', resumeName:'小明-简历.pdf', resumeData:null, skills:['Excel 高级','英语六级'], status:'待审核', appliedAt: now()-86400*2}
    ]
  };
  // resumes: username -> resume object {name,type,data}
  const resumes = {
    '小明': {name:'小明-简历.pdf', type:'application/pdf', data: null}
  };

  storageSet(APP.jobsKey, jobs);
  storageSet(APP.skillsKey, skills);
  storageSet(APP.chatsKey, chats);
  storageSet(APP.appliedKey, applied);
  storageSet(APP.resumesKey, resumes);
  storageSet(APP.userKey, null);
}

/* ================ 辅助函数 ================ */
function formatTime(ts){
  if(!ts) return '';
  const d = new Date(ts);
  const YYYY = d.getFullYear();
  const MM = String(d.getMonth()+1).padStart(2,'0');
  const DD = String(d.getDate()).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${YYYY}-${MM}-${DD} ${hh}:${mm}`;
}
function shortTime(ts){
  const d = new Date(ts); return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
}

/* ============== 视图控制 ============== */
const VIEWS = {
  login: $('#view-login'),
  home: $('#view-home'),
  recruit: $('#view-recruit'),
  job: $('#view-job'),
  post: $('#view-post'),
  chat: $('#view-chat'),
  skills: $('#view-skills'),
  my: $('#view-my')
};
let currentView = 'login';
function show(view){
  if(currentView === view) return; // 避免重复切换到相同视图
  
  Object.values(VIEWS).forEach(v => v.classList.add('hidden'));
  VIEWS[view].classList.remove('hidden');
  currentView = view;
  updateBottomNavActive(view);
  // 只在需要时重新渲染当前视图，避免不必要的性能开销
  if(view === 'home') renderJobList();
  else if(view === 'recruit') renderRecruitList();
  else if(view === 'chat') renderChatThreadsList();
  else if(view === 'my') renderMyView();
  else if(view === 'skills') renderSkillsList();
}

/* ============== 登录与用户 ============== */
function loginUser(name, role, loginType='password'){
  if(!name) return alert('请输入用户名');
  if(!role) return alert('请选择身份');
  let user;
  if(name === '小明') user = {name:'小明', role:role, org:'广西大学', loginType};
  else if(name === '小红') user = {name:'小红', role:role, org:'小红商贸', loginType};
  else user = {name:name, role:role, org:'--', loginType};
  
  // 记住密码功能
  const rememberMe = $('#rememberMe').checked;
  if(rememberMe && loginType === 'password') {
    const password = $('#loginPass').value.trim();
    storageSet('cj_remembered_user', {username: name, password: password, role: role});
  } else {
    storageSet('cj_remembered_user', null);
  }
  
  storageSet(APP.userKey, user);
  // 根据选择的身份自动切换到对应的端口视图
  if(role === 'recruiter') {
    show('recruit'); // 雇主端显示招聘管理页面
  } else {
    show('home'); // 学生端显示岗位列表页面
  }
  // 在页面跳转后再执行header渲染和demo job创建，避免阻塞跳转
  setTimeout(() => {
    renderHeader();
    // create demo jobs for recruiter if they have none
    if(user.role === 'recruiter'){
      const jobs = storageGet(APP.jobsKey, []);
      const hasOwn = jobs.some(j => j.owner === user.name);
      if(!hasOwn){
        const demo = [
          {id:'J-'+uid(), title:'校园海报派发', type:'活动', pay:120, time:'周末', loc:'校内主干道', daily:'否', desc:'派发传单/海报，引导路人扫码。', contact:'小红 13900003333', flags:['近校'], owner:user.name, deposit: Math.max(50, Math.round(120*0.05)), created: now()-3600*1000},
          {id:'J-'+uid(), title:'店内促销兼职', type:'促销', pay:220, time:'周末 10:00-18:00', loc:'附近商场', daily:'是', desc:'服装店促销，形象良好，提供午餐。', contact:'小红 13900003333', flags:['高薪','包餐'], owner:user.name, deposit: Math.max(50, Math.round(220*0.05)), created: now()-3600*2000}
        ];
        storageSet(APP.jobsKey, jobs.concat(demo));
      }
    }
  }, 0);
}

$('#btnLogin').onclick = ()=> { 
  const isSmsLogin = $('#smsForm').style.display !== 'none';
  let name;
  if(isSmsLogin) {
    const phone = $('#loginPhone').value.trim();
    const smsCode = $('#loginSms').value.trim();
    if(!phone) return alert('请输入手机号');
    if(!smsCode) return alert('请输入验证码');
    name = phone;
  } else {
    const username = $('#loginUser').value.trim();
    const password = $('#loginPass').value.trim();
    if(!username) return alert('请输入用户名');
    if(!password) return alert('请输入密码');
    name = username;
  }
  const role = $('#loginRole').value;
  if(!role) return alert('请选择身份');
  loginUser(name, role, isSmsLogin ? 'sms' : 'password'); 
};



// 身份选择直接跳转功能 - 添加防抖处理
let roleChangeTimeout = null;
function handleRoleChange() {
  const role = $('#loginRole').value;
  if(!role) return;
  
  const user = storageGet(APP.userKey);
  
  // 如果没有用户登录，不需要防抖处理，直接返回
  if(!user) return;
  
  // 清除之前的定时器，实现防抖
  if(roleChangeTimeout) clearTimeout(roleChangeTimeout);
  
  roleChangeTimeout = setTimeout(() => {
    // 如果用户已登录，直接跳转到对应界面
    if(role === 'recruiter') {
      show('recruit'); // 雇主端显示招聘管理页面
    } else {
      show('home'); // 学生端显示岗位列表页面
    }
  }, 100); // 100ms防抖延迟
}

// 登录方式切换 - 优化性能
$('#tabPassword').onclick = ()=> {
  if(!$('#tabPassword').classList.contains('active')) {
    $('#tabPassword').classList.add('active');
    $('#tabSms').classList.remove('active');
    $('#passwordForm').style.display = 'block';
    $('#smsForm').style.display = 'none';
  }
};

$('#tabSms').onclick = ()=> {
  if(!$('#tabSms').classList.contains('active')) {
    $('#tabSms').classList.add('active');
    $('#tabPassword').classList.remove('active');
    $('#smsForm').style.display = 'block';
    $('#passwordForm').style.display = 'none';
  }
};

// 验证码发送功能 - 优化性能
$('#btnSendSms').onclick = ()=> {
  const phone = $('#loginPhone').value.trim();
  if(!phone) return alert('请输入手机号');
  if(!/^1[3-9]\d{9}$/.test(phone)) return alert('请输入正确的手机号');
  
  // 模拟发送验证码
  let countdown = 60;
  $('#btnSendSms').disabled = true;
  $('#btnSendSms').textContent = `${countdown}秒后重发`;
  
  // 使用requestAnimationFrame优化动画性能
  const timer = setInterval(() => {
    countdown--;
    if(countdown <= 0) {
      clearInterval(timer);
      requestAnimationFrame(() => {
        $('#btnSendSms').disabled = false;
        $('#btnSendSms').textContent = '获取验证码';
      });
    } else {
      requestAnimationFrame(() => {
        $('#btnSendSms').textContent = `${countdown}秒后重发`;
      });
    }
  }, 1000);
  
  alert('验证码已发送：123456（演示用）');
};

// 记住密码自动填充 - 优化性能
function initRememberMe() {
  const remembered = storageGet('cj_remembered_user');
  if(remembered) {
    // 使用requestAnimationFrame避免阻塞UI
    requestAnimationFrame(() => {
      $('#loginUser').value = remembered.username;
      $('#loginPass').value = remembered.password || '';
      $('#loginRole').value = remembered.role;
      $('#rememberMe').checked = true;
    });
  }
}

// 初始化登录页面 - 延迟执行避免阻塞
setTimeout(initRememberMe, 100);

/* ============== 退出登录 ============== */
function logout(){
  storageSet(APP.userKey, null);
  renderHeader();
  renderBottomNav();
  // 直接显示首页，避免不必要的renderAll调用
  show('home');
}

function resetLoginState(){
  if(confirm('确定要重置登录状态吗？这将清除所有登录信息和记住的账号数据。')){
    storageSet(APP.userKey, null);
    storageSet('cj_remembered_user', null);
    storageSet('cj_user_v3', null);
    alert('登录状态已重置，页面将刷新');
    location.reload();
  }
}

/* ============== Header & bottom nav generation ============== */
function renderHeader(){
  const user = storageGet(APP.userKey);
  const roleText = user ? (user.role === 'recruiter' ? '招聘端' : '学生端') : '';
  const roleTag = user ? (user.role === 'recruiter' ? '招聘' : '学生') : '';
  const avatarText = user && user.name ? user.name[0] : '小';
  const nameText = user ? user.name : '未登录';
  const schoolText = user ? user.org : '--';
  const myRoleText = user ? (user.role === 'recruiter' ? '招聘端' : '学生端') : '';
  
  // 只在值发生变化时更新DOM，避免不必要的重绘
  if($('#roleBtn').textContent !== roleText) $('#roleBtn').textContent = roleText;
  if($('#roleTag').textContent !== roleTag) $('#roleTag').textContent = roleTag;
  if($('#avatar').textContent !== avatarText) $('#avatar').textContent = avatarText;
  if($('#profileName').textContent !== nameText) $('#profileName').textContent = nameText;
  if($('#profileSchool').textContent !== schoolText) $('#profileSchool').textContent = schoolText;
  if($('#myRole').textContent !== myRoleText) $('#myRole').textContent = myRoleText;
  
  // bottom nav
  renderBottomNav();
}

/* bottom nav depends on role */
let lastNavRole = null;
let lastNavHTML = '';

function renderBottomNav(){
  const user = storageGet(APP.userKey);
  const currentRole = user ? user.role : 'guest';
  
  // 如果角色没有变化且导航栏内容相同，则跳过重绘
  if(currentRole === lastNavRole && lastNavHTML === document.querySelector('nav.bottom').innerHTML) {
    updateBottomNavActive(currentView);
    return;
  }
  
  const nav = document.querySelector('nav.bottom');
  let navHTML = '';
  
  if(!user){
    // default student nav
    navHTML = `<div class="tab" data-view="home">首页</div><div class="tab" data-view="skills">技能</div><div class="tab" data-view="chat">消息</div><div class="tab" data-view="my">我的</div>`;
  } else if(user.role === 'student'){
    navHTML = `<div class="tab" data-view="home">首页</div><div class="tab" data-view="skills">技能</div><div class="tab" data-view="chat">消息</div><div class="tab" data-view="my">我的</div>`;
  } else {
    // recruiter tabs: Dashboard, Post, Messages, My
    navHTML = `<div class="tab" data-view="recruit">招聘</div><div class="tab" data-view="post">发布</div><div class="tab" data-view="chat">消息</div><div class="tab" data-view="my">我的</div>`;
  }
  
  // 只在HTML内容发生变化时更新DOM
  if(nav.innerHTML !== navHTML) {
    nav.innerHTML = navHTML;
    lastNavHTML = navHTML;
    
    // bind events
    $$('.bottom .tab').forEach(t=> t.onclick = ()=> {
      const v = t.dataset.view;
      if(v === 'home') show('home');
      else if(v === 'skills') show('skills');
      else if(v === 'recruit') show('recruit');
      else if(v === 'post') show('post');
      else if(v === 'chat') show('chat');
      else if(v === 'my') show('my');
    });
  }
  
  lastNavRole = currentRole;
  // 根据当前视图设置active状态
  updateBottomNavActive(currentView);
}
function updateBottomNavActive(view){
  const tabs = $$('.bottom .tab');
  tabs.forEach(t=> t.classList.remove('active'));
  // 找到对应的tab并添加active类
  tabs.forEach(t=> { 
    if(t.dataset.view === view) {
      t.classList.add('active');
    }
  });
}

/* ============== 渲染与业务逻辑 ============== */

/* 渲染岗位列表（学生首页） */
function renderJobList(){
  const jobs = storageGet(APP.jobsKey, []);
  const q = $('#q').value.trim().toLowerCase();
  const type = $('#typeFilter').value;
  const actives = $$('.chip.active').map(c=>c.dataset.fast);
  let list = jobs.slice().sort((a,b)=> b.created - a.created);
  list = list.filter(j=>{
    const matchQ = !q || (j.title+j.desc+j.loc+j.type).toLowerCase().includes(q);
    const matchT = !type || j.type === type;
    const matchF = actives.length===0 || (j.flags||[]).some(f=>actives.includes(f));
    return matchQ && matchT && matchF;
  });
  $('#jobList').innerHTML = list.map(j=>`
    <div class="job card" data-id="${j.id}">
      <h3>${j.title}</h3>
      <div class="meta"><div class="salary">¥${j.pay}</div><div class="chip">${j.type}</div><div class="chip">${j.loc}</div></div>
      <div class="muted" style="margin-top:8px">${j.time} · 联系：${j.contact}</div>
    </div>
  `).join('') || '<div class="card muted">暂无岗位</div>';
  $$('#jobList .job').forEach(el=> el.onclick = ()=> openJob(el.dataset.id));
}

/* render recruit list for recruiter dashboard */
function renderRecruitList(){
  const jobs = storageGet(APP.jobsKey, []);
  const user = storageGet(APP.userKey);
  if(!user) return;
  const mine = jobs.filter(j => j.owner === user.name);
  if(mine.length === 0){
    $('#recruitList').innerHTML = `<div class="card muted">你尚未发布岗位。<div style="height:8px"></div><button class="btn" id="goPostBtn">发布岗位</button></div>`;
    // 立即绑定事件，避免setTimeout导致的延迟
    const btn = $('#goPostBtn');
    if(btn) btn.onclick = ()=> show('post');
    return;
  }
  $('#recruitList').innerHTML = mine.map(j=>`
    <div class="card" style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:800">${j.title}</div>
          <div class="muted">${j.type} · ¥${j.pay} · ${j.loc}</div>
        </div>
        <div style="text-align:right">
          <div class="muted">保证金 ¥${j.deposit}</div>
          <div style="height:6px"></div>
          <div class="row">
            <button class="btn small view-job-btn" data-job="${j.id}">查看</button>
            <div style="width:8px"></div>
            <button class="btn small applicants-btn" data-job="${j.id}">报名</button>
          </div>
        </div>
      </div>
    </div>
  `).join('');
  
  // 使用事件委托提高性能
  $$('#recruitList .view-job-btn').forEach(btn => {
    btn.onclick = (e) => viewJobFromList(e);
  });
  $$('#recruitList .applicants-btn').forEach(btn => {
    btn.onclick = (e) => openApplicants(e);
  });
}

/* open job from recruiter list */
function viewJobFromList(e){ openJob(e.currentTarget.dataset.job); }

/* open applicants list for recruiter */
function openApplicants(e){
  const jobId = e.currentTarget.dataset.job;
  const applied = storageGet(APP.appliedKey, {});
  const apps = applied[jobId] || [];
  const html = apps.length ? apps.map(a=>`
    <div class="card" style="margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><b>${a.name}</b><div class="mutedSmall">${a.skills ? a.skills.join('，') : ''}</div></div>
        <div style="text-align:right">
          <div class="mutedSmall">状态：${a.status}</div>
          <div style="height:6px"></div>
          <div class="row">
            <button class="btn small" onclick="viewApplicant('${jobId}','${a.name}')">查看</button>
            <div style="width:8px"></div>
            <button class="btn secondary small" onclick="messageApplicant('${jobId}','${a.name}')">沟通</button>
          </div>
        </div>
      </div>
    </div>
  `).join('') : '<div class="card muted">暂无报名</div>';
  showModal(`<div style="max-height:320px;overflow:auto">${html}</div>`, ()=>{}, false);
}

/* view a specific applicant: show resume + skills + approve/reject */
function viewApplicant(jobId, applicantName){
  // gather applied entry
  const applied = storageGet(APP.appliedKey, {});
  const apps = applied[jobId] || [];
  const a = apps.find(x=> x.name === applicantName);
  const resumes = storageGet(APP.resumesKey, {});
  const userResume = a && a.resumeName ? {name: a.resumeName, data: a.resumeData} : (resumes[applicantName] || null);
  const skills = a && a.skills ? a.skills : [];
  const html = `
    <div style="font-weight:700">${applicantName} · 应聘岗位</div>
    <div class="mutedSmall" style="margin-top:6px">提交时间：${formatTime(a ? a.appliedAt : now())}</div>
    <div style="height:8px"></div>
    <div style="font-weight:700">技能</div>
    <div class="mutedSmall">${skills.join('，')}</div>
    <div style="height:8px"></div>
    <div style="font-weight:700">简历</div>
    <div class="mutedSmall">${userResume ? userResume.name : '未上传简历'}</div>
    <div style="height:8px"></div>
    <div class="row"><button class="btn" id="approveBtn">通过</button><div style="width:8px"></div><button class="btn secondary" id="rejectBtn">拒绝</button></div>
  `;
  showModal(html, ()=>{}, true);
  // bind modal confirm buttons manually
  setTimeout(()=>{
    $('#approveBtn').onclick = ()=> {
      approveApplicant(jobId, applicantName);
      $('#modalBox').classList.remove('show'); setTimeout(()=> $('#modal').style.display='none', 220);
    };
    $('#rejectBtn').onclick = ()=> {
      rejectApplicant(jobId, applicantName);
      $('#modalBox').classList.remove('show'); setTimeout(()=> $('#modal').style.display='none', 220);
    };
  }, 60);
}

function approveApplicant(jobId, applicantName){
  const applied = storageGet(APP.appliedKey, {});
  const apps = applied[jobId] || [];
  const a = apps.find(x=> x.name === applicantName);
  if(!a) return alert('找不到申请人');
  a.status = '已通过';
  storageSet(APP.appliedKey, applied);
  // add chat system message to job chat
  const chats = storageGet(APP.chatsKey, {});
  chats[jobId] = chats[jobId] || [];
  chats[jobId].push({sender:'系统', text:`雇主已通过 ${applicantName} 的申请`, time: now(), system:true});
  storageSet(APP.chatsKey, chats);
  alert('已通过申请，系统消息已发送');
  renderMyRecords();
  renderRecruitList();
}

function rejectApplicant(jobId, applicantName){
  const applied = storageGet(APP.appliedKey, {});
  const apps = applied[jobId] || [];
  const a = apps.find(x=> x.name === applicantName);
  if(!a) return alert('找不到申请人');
  a.status = '已拒绝';
  storageSet(APP.appliedKey, applied);
  const chats = storageGet(APP.chatsKey, {});
  chats[jobId] = chats[jobId] || [];
  chats[jobId].push({sender:'系统', text:`雇主已拒绝 ${applicantName} 的申请`, time: now(), system:true});
  storageSet(APP.chatsKey, chats);
  alert('已拒绝申请，系统消息已发送');
  renderMyRecords();
  renderRecruitList();
}

/* 打开岗位详情 */
function openJob(id){
  const jobs = storageGet(APP.jobsKey, []);
  const job = jobs.find(j=> j.id === id);
  if(!job) return alert('岗位不存在');
  $('#jobDetailWrap').innerHTML = `
    <div class="card">
      <div class="title">${job.title}</div>
      <div class="muted">${job.type} · ${job.loc}</div>
      <div style="height:8px"></div>
      <div class="muted">薪资 <b>¥${job.pay}</b> · 保证金 <b>¥${job.deposit}</b></div>
      <div style="height:8px"></div>
      <div class="muted"><b>时间：</b>${job.time}</div>
      <div style="height:8px"></div>
      <div>${job.desc}</div>
      <div style="height:8px"></div>
      <div class="muted"><b>联系人：</b> ${job.contact}</div>
      <div style="height:8px"></div>
      <div class="mutedSmall">发布方： ${job.owner}</div>
    </div>
  `;
  $('#jobApply').onclick = ()=> applyForJob(job.id);
  $('#jobChat').onclick = ()=> openChat(job.id);
  show('job');
}

/* 学生报名 -> 创建申请对象并拷贝当前简历/skills快照 */
function applyForJob(jobId){
  const user = storageGet(APP.userKey);
  if(!user) return alert('请登录');
  if(user.role !== 'student') return alert('请切换为学生端报名');
  const resumes = storageGet(APP.resumesKey, {});
  const myResume = resumes[user.name] || null;
  if(!myResume || !myResume.name) {
    if(!confirm('你尚未上传简历，是否继续报名（可在报名后补充）？')) return;
  }
  const skillsAll = storageGet(APP.skillsKey, []);
  const mySkills = skillsAll.filter(s => s.owner === user.name).map(s=> s.name);
  const applied = storageGet(APP.appliedKey, {});
  applied[jobId] = applied[jobId] || [];
  const already = applied[jobId].some(a => a.name === user.name);
  if(already) { alert('你已报名该岗位'); openChat(jobId); return; }
  const applicant = {
    name: user.name,
    resumeName: myResume ? myResume.name : null,
    resumeData: myResume ? myResume.data : null,
    skills: mySkills,
    status: '待审核',
    appliedAt: now()
  };
  applied[jobId].push(applicant);
  storageSet(APP.appliedKey, applied);
  // add chat message indicating application
  const chats = storageGet(APP.chatsKey, {});
  chats[jobId] = chats[jobId] || [];
  chats[jobId].push({sender:user.name, text:`我已提交申请，请审核 - ${user.name}`, time: now()});
  storageSet(APP.chatsKey, chats);
  alert('报名成功，已发送沟通消息给雇主');
  openChat(jobId);
  renderMyRecords();
}

/* Chat threads and messages */
/* For student: threads = jobs where user applied or chat has messages from user
   For recruiter: threads = jobs owned by recruiter */
function getChatThreads(){
  const user = storageGet(APP.userKey);
  const jobs = storageGet(APP.jobsKey, []);
  const applied = storageGet(APP.appliedKey, {});
  const chats = storageGet(APP.chatsKey, {});
  const threads = [];
  // For each job, if chat exists and role appropriate, include
  jobs.forEach(job=>{
    const msgs = chats[job.id] || [];
    if(user.role === 'student'){
      // include if user applied OR user has messages in chat
      const appliedList = applied[job.id] || [];
      const appliedByUser = appliedList.some(a=> a.name === user.name);
      const userInChat = msgs.some(m => m.sender === user.name);
      if(appliedByUser || userInChat) {
        const last = msgs[msgs.length-1];
        threads.push({job, last});
      }
    } else {
      // recruiter: include jobs owned by user
      if(job.owner === user.name) {
        const last = msgs[msgs.length-1];
        threads.push({job, last});
      }
    }
  });
  // sort by last message time desc
  threads.sort((a,b)=>{
    const ta = a.last ? a.last.time : 0;
    const tb = b.last ? b.last.time : 0;
    return tb - ta;
  });
  return threads;
}

function renderChatThreadsList(){
  const threads = getChatThreads();
  // 沟通示例（静态3个）- 按沟通时间排列的不同学生
  const demoExamples = [
    {id: 'demo-1', title: '高等数学一对一家教', preview: '小明：有的，曾在补习班任教，能提供试讲。', time: '4/1 19:00'},
    {id: 'demo-2', title: '商场新品促销员', preview: '小红：可以，请问几点集合？', time: '4/2 10:00'},
    {id: 'demo-3', title: '软件测试兼职（远程）', preview: '小李：请问有相关测试经验吗？', time: '4/3 15:30'}
  ];
  const demoHtml = demoExamples.map(e =>
    `<div class="card" style="margin-bottom:8px;opacity:0.7;cursor:pointer" onclick="openDemoChat('${e.id}')"><div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:700">${e.title}</div><div class="mutedSmall">${e.preview}</div></div><div style="text-align:right"><div class="mutedSmall">${e.time}</div><div style="height:6px"></div><button class="btn small" onclick="event.stopPropagation();openDemoChat('${e.id}')">打开</button></div></div></div>`
  ).join('');
  const html = threads.length ? threads.map(t=>{
    const lm = t.last;
    const preview = lm ? (lm.system ? ('[系统] '+lm.text) : lm.text) : '暂无消息';
    const time = lm ? shortTime(lm.time) : '';
    return `<div class="card" style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:center"><div onclick="openChat('${t.job.id}')" style="cursor:pointer"><div style="font-weight:700">${t.job.title}</div><div class="mutedSmall">${preview}</div></div><div style="text-align:right"><div class="mutedSmall">${time}</div><div style="height:6px"></div><button class="btn small" onclick="openChat('${t.job.id}')">打开</button></div></div></div>`;
  }).join('') : '<div class="card muted">暂无会话</div>';
  // if currently on chat view, render在顶部插入示例
  if(currentView === 'chat'){
    $('#messages').innerHTML = '<div class="mutedSmall">请选择会话或在岗位详情中打开沟通</div>' + demoHtml + html;
  } else {
    return demoHtml + html;
  }
}

/* render chat view messages for a job */
let currentChatJob = null;
function renderChat(jobId){
  currentChatJob = jobId;
  const chats = storageGet(APP.chatsKey, {});
  const msgs = chats[jobId] || [];
  // sort ascending by time
  msgs.sort((a,b)=> a.time - b.time);
  // render messages with timestamps and system messages
  $('#messages').innerHTML = msgs.map(m=>{
    if(m.system) return `<div class="msg system">${m.text}<div class="time">${formatTime(m.time)}</div></div>`;
    const cls = (m.sender === (storageGet(APP.userKey).name)) ? 'me' : 'other';
    return `<div class="msg ${cls}"><div>${m.text}</div><div class="time">${m.sender} · ${formatTime(m.time)}</div></div>`;
  }).join('') || '<div class="muted">暂无消息，点击底部输入发送。</div>';
  // header set
  const jobs = storageGet(APP.jobsKey, []);
  const job = jobs.find(j=> j.id === jobId) || {title:'会话'};
  $('#chatTitle').textContent = `沟通：${job.title}`;
  $('#chatSub').textContent = `联系人：${job.contact}`;
  // bind send
  $('#sendMsg').onclick = ()=>{
    const text = $('#chatInput').value.trim(); if(!text) return;
    const user = storageGet(APP.userKey);
    const chats2 = storageGet(APP.chatsKey, {});
    chats2[jobId] = chats2[jobId] || [];
    chats2[jobId].push({sender: user.name, text, time: now()});
    storageSet(APP.chatsKey, chats2);
    $('#chatInput').value = '';
    renderChat(jobId);
  };
  $('#endChat').onclick = ()=> show('messages');
}

/* open chat by job (and show chat view) */
function openChat(jobId){
  renderChat(jobId);
  show('chat');
}

/* ============== 技能/简历/我的区 ============== */
function renderSkills(){
  const skills = storageGet(APP.skillsKey, []);
  const user = storageGet(APP.userKey);
  const mine = skills.filter(s => user && s.owner === user.name);
  $('#skillList').innerHTML = mine.map(s=>`<div class="skill">${s.name} · ${s.level}${s.status?(' · '+s.status):''}</div>`).join('') || '<div class="mutedSmall">暂无技能</div>';
  $('#mySkills').innerHTML = skills.filter(s => s.owner === (user && user.name)).map(s=>`<div class="skill">${s.name}<div style="font-size:12px;color:#718096">${s.level} ${s.status?(' · '+s.status):''}</div></div>`).join('') || '<div class="mutedSmall">暂无技能</div>';
}

/* submit skill (student) */
$('#addSkill').onclick = ()=>{
  const user = storageGet(APP.userKey); if(!user) return alert('请先登录');
  const name = $('#skillName').value.trim(); const level = $('#skillLevel').value;
  if(!name) return alert('请输入技能名称');
  // handle file briefly (not storing heavy data)
  const fileInput = $('#skillFile'); const file = fileInput.files[0];
  const skills = storageGet(APP.skillsKey, []);
  skills.push({id:'SK'+uid(), owner:user.name, name, level, status:'待审核', fileName: file ? file.name : null});
  storageSet(APP.skillsKey, skills);
  $('#skillName').value=''; $('#skillFile').value='';
  alert('技能已提交，等待雇主/平台审核（原型）');
  renderSkills();
};

/* render resume info for current user */
function renderResumeInfo(){
  const resumes = storageGet(APP.resumesKey, {});
  const user = storageGet(APP.userKey);
  if(!user){ $('#resumeName').textContent = '未登录'; $('#viewResumeBtn').disabled=true; $('#delResumeBtn').disabled=true; return; }
  const r = resumes[user.name];
  if(!r) {
    $('#resumeName').textContent = '未上传简历'; $('#viewResumeBtn').disabled=true; $('#delResumeBtn').disabled=true; $('#resumePreviewWrap').classList.add('hidden'); $('#resumePreviewWrap').innerHTML='';
  } else {
    $('#resumeName').textContent = `${r.name} · ${Math.round((r.size||0)/1024)}KB`;
    $('#viewResumeBtn').disabled = false; $('#delResumeBtn').disabled = false;
    $('#viewResumeBtn').onclick = ()=> {
      if(r.type && r.type.startsWith('image/')) {
        $('#resumePreviewWrap').innerHTML = `<img src="${r.data}" style="max-width:100%;border-radius:8px">`; $('#resumePreviewWrap').classList.remove('hidden');
      } else if(r.type === 'application/pdf'){
        $('#resumePreviewWrap').innerHTML = `<iframe src="${r.data}" style="width:100%;height:320px;border:0"></iframe>`; $('#resumePreviewWrap').classList.remove('hidden');
      } else {
        $('#resumePreviewWrap').innerHTML = `<div style="padding:12px">无法预览此类型文件。文件名：${r.name}</div>`; $('#resumePreviewWrap').classList.remove('hidden');
      }
    };
    $('#delResumeBtn').onclick = ()=> {
      if(confirm('删除已上传简历？')){
        delete resumes[user.name];
        storageSet(APP.resumesKey, resumes);
        renderResumeInfo();
        alert('简历已删除');
      }
    };
  }
}

/* resume upload */
$('#resumeUpload').onchange = (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const user = storageGet(APP.userKey);
  if(!user) return alert('请先登录上传简历');
  const reader = new FileReader();
  reader.onload = (ev)=>{
    const data = ev.target.result; // dataURL or arraybuffer base64
    const resumes = storageGet(APP.resumesKey, {});
    resumes[user.name] = {name: f.name, type: f.type, size: f.size, data};
    storageSet(APP.resumesKey, resumes);
    renderResumeInfo();
    alert('简历已上传（本地保存）');
  };
  if(f.type.startsWith('image/') || f.type === 'application/pdf') reader.readAsDataURL(f);
  else {
    // read as arraybuffer and store as base64
    reader.readAsArrayBuffer(f);
    reader.onload = (ev)=>{
      const arr = new Uint8Array(ev.target.result); let binary=''; for(let i=0;i<arr.byteLength;i++) binary+=String.fromCharCode(arr[i]);
      const b64 = btoa(binary); const dataUrl = 'data:application/octet-stream;base64,'+b64;
      const resumes = storageGet(APP.resumesKey, {}); resumes[user.name] = {name: f.name, type: f.type, size: f.size, data: dataUrl}; storageSet(APP.resumesKey, resumes);
      renderResumeInfo(); alert('简历已上传（本地保存）');
    };
  }
};

/* render 'My Records' */
function renderMyRecords(){
  const user = storageGet(APP.userKey);
  const jobs = storageGet(APP.jobsKey, []);
  const applied = storageGet(APP.appliedKey, {});
  if(!user) return;
  if(user.role === 'student'){
    // show my applied jobs
    const myAppIds = Object.keys(applied).filter(jobId => (applied[jobId] || []).some(a => a.name === user.name));
    const html = myAppIds.length ? myAppIds.map(id=>{
      const j = jobs.find(x=>x.id===id);
      const a = (applied[id] || []).find(x=>x.name === user.name);
      return `<div class="card" style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:center"><div><b>${j.title}</b><div class="mutedSmall">${j.type} · ¥${j.pay}</div><div class="mutedSmall">申请状态：${a.status}</div></div><div><button class="btn small" onclick="openChat('${j.id}')">沟通</button></div></div></div>`;
    }).join('') : '<div class="muted">暂无报名记录</div>';
    $('#myRecords').innerHTML = html;
  } else {
    // recruiter: show my published jobs and applicant counts
    const mine = jobs.filter(j=> j.owner === user.name);
    const html = mine.length ? mine.map(j=>{
      const apps = storageGet(APP.appliedKey, {})[j.id] || [];
      return `<div class="card" style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:center"><div><b>${j.title}</b><div class="mutedSmall">报名 ${apps.length} 人 · 保证金 ¥${j.deposit}</div></div><div><button class="btn small" onclick="openApplicantsById('${j.id}')">查看报名</button></div></div></div>`;
    }).join('') : '<div class="muted">暂无发布记录</div>';
    $('#myRecords').innerHTML = html;
  }
}

function openApplicantsById(jobId){
  const applied = storageGet(APP.appliedKey, {});
  const arr = applied[jobId] || [];
  const html = arr.length ? arr.map(a=>`<div style="padding:8px;border-bottom:1px solid #eef6f5"><b>${a.name}</b><div class="mutedSmall">${a.skills ? a.skills.join('、') : ''} · 状态：${a.status}</div><div style="height:8px"></div><div class="row"><button class="btn small" onclick="viewApplicant('${jobId}','${a.name}')">查看/审核</button><div style="width:8px"></div><button class="btn secondary small" onclick="messageApplicant('${jobId}','${a.name}')">沟通</button></div></div>`).join('') : '<div class="muted">暂无报名</div>';
  showModal(`<div style="max-height:360px;overflow:auto">${html}</div>`, ()=>{}, false);
}

/* message to applicant (open chat and focus on the job) */
function messageApplicant(jobId, applicantName){
  // open chat for that job, and prefill message
  openChat(jobId);
  $('#chatInput').value = `@${applicantName} 您好，关于您的申请我们想进一步沟通。`;
}

/* ============== 审核工作流 for recruiter (skills) ============== */
function renderReviewQueue(){
  const skills = storageGet(APP.skillsKey, []);
  const pending = skills.filter(s => s.status === '待审核');
  if(pending.length === 0) {
    $('#reviewQueue').innerHTML = '<div class="muted">暂无待审核项</div>'; return;
  }
  $('#reviewQueue').innerHTML = pending.map(s=>`
    <div class="card" style="margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><b>${s.name}</b><div class="mutedSmall">${s.owner} · ${s.level}</div></div>
        <div>
          <button class="btn small" onclick="approveSkill('${s.id}')">通过</button>
          <div style="height:8px"></div>
          <button class="btn secondary small" onclick="rejectSkill('${s.id}')">拒绝</button>
        </div>
      </div>
    </div>
  `).join('');
}

function approveSkill(skillId){
  const skills = storageGet(APP.skillsKey, []);
  const sk = skills.find(s=> s.id === skillId);
  if(!sk) return alert('未找到该技能');
  sk.status = '已认证';
  storageSet(APP.skillsKey, skills);
  // push system message to all jobs? better: send system message to applicant's first job chats or global chat: add to all chats related to that applicant
  const chats = storageGet(APP.chatsKey, {});
  Object.keys(chats).forEach(jobId=>{
    chats[jobId].push({sender:'系统', text:`雇主已通过 ${sk.owner} 的技能认证：${sk.name}`, time: now(), system:true});
  });
  storageSet(APP.chatsKey, chats);
  alert('技能已通过，已发送系统通知（演示）');
  renderReviewQueue(); renderSkills();
}

function rejectSkill(skillId){
  const skills = storageGet(APP.skillsKey, []);
  const sk = skills.find(s=> s.id === skillId);
  if(!sk) return alert('未找到该技能');
  sk.status = '已拒绝';
  storageSet(APP.skillsKey, skills);
  const chats = storageGet(APP.chatsKey, {});
  Object.keys(chats).forEach(jobId=>{
    chats[jobId].push({sender:'系统', text:`雇主拒绝了 ${sk.owner} 的技能认证：${sk.name}`, time: now(), system:true});
  });
  storageSet(APP.chatsKey, chats);
  alert('技能已拒绝并发送系统通知（演示）');
  renderReviewQueue(); renderSkills();
}

/* ============== Modal / UI helpers ============== */
function showModal(html, onConfirm, showConfirm=true){
  $('#modalBody').innerHTML = html;
  $('#modal').style.display = 'flex';
  setTimeout(()=> $('#modalBox').style.transform = 'translateY(0)', 20);
  setTimeout(()=> $('#modalBox').style.opacity = '1', 20);
  $('#modalConfirm').onclick = ()=> { $('#modalBox').style.transform = 'translateY(20px)'; setTimeout(()=> $('#modal').style.display='none', 220); if(onConfirm) onConfirm(); };
  $('#modalCancel').onclick = ()=> { $('#modalBox').style.transform = 'translateY(20px)'; setTimeout(()=> $('#modal').style.display='none', 220); };
  $('#modalConfirm').style.display = showConfirm ? '' : 'none';
}

/* ============== render everything ============== */
function renderAll(){
  renderHeader();
  
  // 只渲染当前视图相关的组件，避免不必要的性能开销
  switch(currentView) {
    case 'home':
      renderJobList();
      break;
    case 'recruit':
      renderRecruitList();
      break;
    case 'skills':
      renderSkills();
      renderReviewQueue();
      break;
    case 'my':
      renderMyView();
      renderMyRecords();
      renderResumeInfo();
      break;
    case 'chat':
      renderChatThreadsList();
      break;
    case 'login':
      // 登录页面不需要渲染其他组件
      break;
    default:
      // 默认情况下不渲染任何组件，避免不必要的性能开销
      break;
  }
}

/* ============== Event binds ============== */
function attachEvents(){
  $('#q').addEventListener('input', debounce(()=> renderJobList(), 200));
  $('#typeFilter').onchange = ()=> renderJobList();
  $$('.chip').forEach(c=> c.onclick = ()=> { c.classList.toggle('active'); renderJobList(); });

  $('#goSkills').onclick = ()=> { show('skills'); renderBottomActive('skills'); };
  $('#btnNewPost').onclick = ()=> show('post');
  $('#calcDepositBtn').onclick = ()=> $('#depositShow').textContent = '¥' + calcDeposit($('#p_pay').value||0);
  $('#submitPost').onclick = submitPost;
  $('#cancelPost').onclick = ()=> show('recruit');

  // modal hide
  $('#modalCancel').onclick = ()=> { $('#modalBox').style.transform = 'translateY(20px)'; setTimeout(()=> $('#modal').style.display='none', 220); };

  // role toggle in header: only toggle if logged in
  $('#roleBtn').onclick = ()=>{
    const user = storageGet(APP.userKey);
    if(!user) return alert('请先登录以切换角色');
    user.role = user.role === 'recruiter' ? 'student' : 'recruiter';
    storageSet(APP.userKey, user);
    // 只更新必要的UI元素，避免不必要的重渲染
    $('#roleBtn').textContent = user.role === 'recruiter' ? '招聘端' : '学生端';
    $('#roleTag').textContent = user.role === 'recruiter' ? '招聘' : '学生';
    $('#myRole').textContent = user.role === 'recruiter' ? '招聘端' : '学生端';
    
    // 根据新角色显示对应的首页视图
    if(user.role === 'recruiter') {
      show('recruit'); // 雇主端显示招聘管理页面
    } else {
      show('home'); // 学生端显示岗位列表页面
    }
  };

  // resume upload bound later in init
}

/* ============== Post / submit logic ============== */
function calcDeposit(pay){ const n = Number(pay)||0; return Math.max(50, Math.round(n*0.05)); }
function submitPost(){
  const user = storageGet(APP.userKey); if(!user) return alert('请登录'); if(user.role !== 'recruiter') return alert('切换为雇主端发布');
  const title = $('#p_title').value.trim(); if(!title) return alert('请输入岗位标题');
  const pay = Number($('#p_pay').value||0); if(!pay) return alert('请输入薪资');
  const deposit = calcDeposit(pay);
  showModal(`即将支付保证金 ¥${deposit}（模拟）。确认发布？`, ()=>{
    const jobs = storageGet(APP.jobsKey, []);
    const job = {id:'J-'+uid(), title, type: $('#p_type').value, pay, time: $('#p_time').value||'--', loc: $('#p_loc').value||'--', desc: $('#p_desc').value||'', contact: $('#p_contact').value||'--', flags: [], owner: storageGet(APP.userKey).name, deposit, created: now()};
    jobs.unshift(job); storageSet(APP.jobsKey, jobs);
    alert('模拟支付成功，岗位已发布');
    // clear
    $('#p_title').value=''; $('#p_pay').value=''; $('#p_time').value=''; $('#p_loc').value=''; $('#p_desc').value=''; $('#p_contact').value='';
    renderAll();
    show('recruit');
  }, true);
}

/* ============== Utility & init ============== */
function debounce(fn,t){ let timer; return (...a)=>{ clearTimeout(timer); timer=setTimeout(()=>fn(...a), t); }; }
function shortTime(ts){ const d=new Date(ts); return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }

function init(){
  initSeed();
  attachEvents();
  renderHeader();
  renderBottomNav();
  // resume input binding
  $('#resumeUpload').onchange = (e)=>{
    const f = e.target.files[0]; if(!f) return alert('未选择文件');
    const user = storageGet(APP.userKey);
    if(!user) return alert('请先登录');
    const reader = new FileReader();
    reader.onload = (ev)=>{
      const data = ev.target.result;
      const resumes = storageGet(APP.resumesKey, {}) || {};
      resumes[user.name] = {name: f.name, type: f.type, size: f.size, data};
      storageSet(APP.resumesKey, resumes);
      renderResumeInfo();
      alert('简历已上传（本地保存）');
    };
    if(f.type.startsWith('image/') || f.type === 'application/pdf') reader.readAsDataURL(f);
    else { reader.readAsArrayBuffer(f); reader.onload = (ev)=>{ const arr = new Uint8Array(ev.target.result); let binary=''; for(let i=0;i<arr.length;i++) binary+=String.fromCharCode(arr[i]); const b64=btoa(binary); const dataUrl = 'data:application/octet-stream;base64,'+b64; const resumes = storageGet(APP.resumesKey, {})||{}; resumes[user.name] = {name:f.name, type:f.type, size:f.size, data:dataUrl}; storageSet(APP.resumesKey, resumes); renderResumeInfo(); alert('简历已上传（本地）'); };}
  };

  // bind opening of chat threads list when entering chat tab: when show('chat') called, show list of threads
  const observer = new MutationObserver(()=>{ /* no-op placeholder */ });
  observer.observe(document.body, {childList:true, subtree:true});
  // initial render - 延迟执行避免阻塞
  setTimeout(() => {
    renderAll();
    // if user logged in, go to role-specific default view, else show login
    const user = storageGet(APP.userKey);
    if(user) {
      renderHeader(); renderBottomNav();
      // 根据用户角色显示对应的默认视图
      if(user.role === 'recruiter') {
        show('recruit'); // 雇主端显示招聘管理页面
      } else {
        show('home'); // 学生端显示岗位列表页面
      }
    } else {
      show('login');
    }
  }, 100);
}

/* ============== helpers to open applicant modal externally ============== */
window.viewApplicant = viewApplicant;
window.openApplicantsById = openApplicantsById;
window.openChat = openChat;
window.openJob = openJob;
window.messageApplicant = messageApplicant;

/* ============== start ============== */
init();

// ============== 渲染与业务逻辑 ==============
// ... existing code ...
function renderMyView() {
  const user = storageGet(APP.userKey);
  const jobs = storageGet(APP.jobsKey, []);
  const applied = storageGet(APP.appliedKey, {});
  const resumes = storageGet(APP.resumesKey, {});
  
  // 清空我的页面内容
  $('#view-my').innerHTML = '';
  
  // 未登录状态显示登录入口模块
  if (!user) {
    $('#view-my').innerHTML = `
      <div id="loginModule" class="card" style="text-align:center;padding:40px 20px;">
        <div style="font-size:18px;font-weight:700;margin-bottom:12px;">登录校兼帮</div>
        <div class="muted" style="margin-bottom:24px;">登录后查看个人中心、报名记录和简历管理</div>
        <div style="display:flex;flex-direction:column;gap:12px;max-width:280px;margin:0 auto;">
          <button class="btn primary" onclick="show('login')" style="width:100%;">立即登录</button>
          <button class="btn secondary" onclick="loginUser('游客')" style="width:100%;">游客体验</button>
        </div>
      </div>
    `;
    return;
  }
  
  let html = '';
  // 个人信息卡片
  html += `<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="avatar" id="avatar">${user.name ? user.name[0] : '用'}</div>
        <div>
          <div style="font-weight:800" id="profileName">${user.name}</div>
          <div class="muted" id="profileSchool">${user.org}</div>
        </div>
      </div>
      <div style="text-align:right">
        <div class="muted">角色</div>
        <div style="height:6px"></div>
        <div id="myRole" class="badge">${user.role === 'recruiter' ? '招聘端' : '学生端'}</div>
        <div style="height:8px"></div>
        <button class="btn secondary small" onclick="logout()" style="margin-top:8px;">退出登录</button>
        <div style="height:8px"></div>
        <button class="btn warning small" onclick="resetLoginState()" style="margin-top:4px;display:none;">重置登录状态</button>
      </div>
    </div>
  </div>`;
  // 学生端内容
  if (user.role === 'student') {
    // 简历卡片
    const r = resumes[user.name];
    html += `<div class="card">
      <div class="title" style="font-size:15px">简历 (可上传)</div>
      <div class="muted">支持 PDF / 图片 / 其他</div>
      <div style="height:8px"></div>
      <div class="resumeBox">
        <input id="resumeUpload" type="file" accept=".pdf,image/*,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" />
        <div id="resumeInfo" style="display:flex;justify-content:space-between;align-items:center">
          <div class="muted" id="resumeName">${r ? r.name + ' · ' + Math.round((r.size||0)/1024) + 'KB' : '未上传简历'}</div>
          <div>
            <button class="btn small" id="viewResumeBtn" ${r ? '' : 'disabled'}>预览</button>
            <button class="btn secondary small" id="delResumeBtn" ${r ? '' : 'disabled'}>删除</button>
          </div>
        </div>
        <div id="resumePreviewWrap" class="resumePreview hidden" style="margin-top:8px"></div>
      </div>
    </div>`;
    // 我的报名
    const myAppIds = Object.keys(applied).filter(jobId => (applied[jobId] || []).some(a => a.name === user.name));
    html += `<div class="card">
      <div class="title">我的报名</div>
      <div id="myRecords">${myAppIds.length ? myAppIds.map(id=>{
        const j = jobs.find(x=>x.id===id);
        const a = (applied[id] || []).find(x=>x.name === user.name);
        return `<div style='margin-bottom:8px'><b>${j.title}</b><div class='mutedSmall'>${j.type} · ¥${j.pay}</div><div class='mutedSmall'>申请状态：${a.status}</div><button class='btn small' onclick='openChat("${j.id}")'>沟通</button></div>`;
      }).join('') : '<div class=\'muted\'>暂无报名记录</div>'}</div>
    </div>`;
    // 示例展示
    html += `<div class="card"><div class="title">示例展示</div><div class="mutedSmall">这里可以放置学生端"我的"页的示例内容。</div></div>`;
  } else {
    // 招聘端内容
    // 已发布岗位
    const mine = jobs.filter(j=> j.owner === user.name);
    html += `<div class="card">
      <div class="title">已发布岗位</div>
      <div id="myPublished">${mine.length ? mine.map(j=>{
        const apps = storageGet(APP.appliedKey, {})[j.id] || [];
        return `<div style='margin-bottom:8px'><b>${j.title}</b><div class='mutedSmall'>${j.type} · ¥${j.pay} · 报名${apps.length}人</div><button class='btn small' onclick='openApplicantsById("${j.id}")'>查看报名</button></div>`;
      }).join('') : '<div class=\'muted\'>暂无发布岗位</div>'}</div>
    </div>`;
    // 示例展示
    html += `<div class="card"><div class="title">示例展示</div><div class="mutedSmall">这里可以放置招聘端"我的"页的示例内容。</div></div>`;
  }
  $('#view-my').innerHTML = html;
  // 绑定简历按钮事件
  if(user.role === 'student') renderResumeInfo();
  
  // 调试信息输出
  console.log('🔍 renderMyView调试信息:');
  console.log('- 用户状态:', user);
  console.log('- 生成的HTML长度:', html.length);
  console.log('- 退出按钮是否包含:', html.includes('退出登录'));
  console.log('- 视图元素:', $('#view-my'));
}
// 打开示例对话
function openDemoChat(demoId) {
  // 创建示例对话数据
  const demoChats = {
    'demo-1': [
      {sender: '王老师', text: '你好，请问有辅导经验吗？', time: now() - 86400 * 3},
      {sender: '小明', text: '有的，曾在补习班任教，能提供试讲。', time: now() - 86400 * 3 + 3600},
      {sender: '王老师', text: '很好，请问什么时候可以开始？', time: now() - 86400 * 2},
      {sender: '小明', text: '这周就可以开始，请问具体时间安排？', time: now() - 86400 * 2 + 1800}
    ],
    'demo-2': [
      {sender: '张经理', text: '我们周六需要3位促销员，提供午餐，是否能来？', time: now() - 86400 * 2},
      {sender: '小红', text: '可以，请问几点集合？', time: now() - 86400 * 2 + 1800},
      {sender: '张经理', text: '上午9点在商场门口集合，记得带身份证。', time: now() - 86400 * 2 + 3600},
      {sender: '小红', text: '好的，我会准时到达。', time: now() - 86400 * 1}
    ],
    'demo-3': [
      {sender: '李工程师', text: '请问有相关测试经验吗？', time: now() - 86400 * 1},
      {sender: '小李', text: '有的，我做过APP测试，熟悉测试流程。', time: now() - 86400 * 1 + 1800},
      {sender: '李工程师', text: '很好，我们主要测试新功能，每周任务制。', time: now() - 86400 * 1 + 3600},
      {sender: '小李', text: '没问题，我可以接受这个安排。', time: now() - 3600 * 2}
    ]
  };
  
  const demoTitles = {
    'demo-1': '高等数学一对一家教',
    'demo-2': '商场新品促销员', 
    'demo-3': '软件测试兼职（远程）'
  };
  
  const demoContacts = {
    'demo-1': '王老师 18800001111',
    'demo-2': '张经理 13900002222',
    'demo-3': '李工程师 13700003333'
  };
  
  // 渲染示例对话
  const msgs = demoChats[demoId] || [];
  msgs.sort((a,b)=> a.time - b.time);
  
  $('#messages').innerHTML = msgs.map(m=>{
    const cls = (m.sender === (storageGet(APP.userKey).name)) ? 'me' : 'other';
    return `<div class="msg ${cls}"><div>${m.text}</div><div class="time">${m.sender} · ${formatTime(m.time)}</div></div>`;
  }).join('') || '<div class="muted">暂无消息</div>';
  
  // 设置对话标题
  $('#chatTitle').textContent = `示例对话：${demoTitles[demoId]}`;
  $('#chatSub').textContent = `联系人：${demoContacts[demoId]}`;
  
  // 跳转到对话界面
  show('chat');
  // 确保消息tab高亮
  updateBottomNavActive('chat');
  
  // 绑定发送消息（示例）
  $('#sendMsg').onclick = ()=>{
    const text = $('#chatInput').value.trim(); 
    if(!text) return;
    const user = storageGet(APP.userKey);
    const newMsg = {sender: user.name, text, time: now()};
    msgs.push(newMsg);
    $('#chatInput').value = '';
    renderDemoChat(demoId, msgs);
  };
  
  $('#endChat').onclick = ()=> {
    show('messages'); // 返回消息列表
  };
}

// 重新渲染示例对话
function renderDemoChat(demoId, msgs) {
  const demoTitles = {
    'demo-1': '高等数学一对一家教',
    'demo-2': '商场新品促销员', 
    'demo-3': '软件测试兼职（远程）'
  };
  
  const demoContacts = {
    'demo-1': '王老师 18800001111',
    'demo-2': '张经理 13900002222',
    'demo-3': '李工程师 13700003333'
  };
  
  $('#messages').innerHTML = msgs.map(m=>{
    const cls = (m.sender === (storageGet(APP.userKey).name)) ? 'me' : 'other';
    return `<div class="msg ${cls}"><div>${m.text}</div><div class="time">${m.sender} · ${formatTime(m.time)}</div></div>`;
  }).join('');
  
  $('#chatTitle').textContent = `示例对话：${demoTitles[demoId]}`;
  $('#chatSub').textContent = `联系人：${demoContacts[demoId]}`;
}





















</script>

<!-- 浮动帮助组件 -->
<div class="floating-help">
    <button class="help-btn" onclick="toggleHelp()">?</button>
    
    <div class="help-panel" id="helpPanel">
        <div class="panel-header">
            <h3>操作指南</h3>
            <button class="close-btn" onclick="toggleHelp()">×</button>
        </div>
        
        <div class="guide-item" onclick="showGuide('login')">
            <h4>🔐 登录操作</h4>
            <p>使用测试账号：小明/小红，密码任意</p>
        </div>
        
        <div class="guide-item" onclick="showGuide('role')">
            <h4>👥 身份切换</h4>
            <p>点击顶部身份按钮实时切换学生/招聘者视角</p>
        </div>
        
        <div class="guide-item" onclick="showGuide('job')">
            <h4>📋 岗位管理</h4>
            <p>浏览、申请、发布和管理招聘岗位</p>
        </div>
        
        <div class="guide-item" onclick="showGuide('chat')">
            <h4>💬 实时沟通</h4>
            <p>与对方角色进行在线消息交流</p>
        </div>
        
        <div class="quick-tips">
            <h4>💡 快速提示</h4>
            <ul>
                <li>双击页面元素查看详细信息</li>
                <li>使用键盘快捷键快速导航</li>
                <li>右键点击获取上下文菜单</li>
            </ul>
        </div>
    </div>
</div>

<style>
.floating-help {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}

.help-btn {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    font-size: 24px;
    transition: all 0.3s ease;
}

.help-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

.help-panel {
    position: absolute;
    bottom: 70px;
    right: 0;
    width: 300px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    padding: 20px;
    display: none;
}

.help-panel.visible {
    display: block;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
}

.panel-header h3 {
    margin: 0;
    color: #2c3e50;
    font-size: 18px;
}

.close-btn {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #999;
}

.close-btn:hover {
    color: #333;
}

.guide-item {
    margin: 10px 0;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #4facfe;
    cursor: pointer;
    transition: all 0.2s ease;
}

.guide-item:hover {
    background: #e3f2fd;
    transform: translateX(-2px);
}

.guide-item h4 {
    margin: 0 0 5px 0;
    color: #2c3e50;
    font-size: 14px;
}

.guide-item p {
    margin: 0;
    color: #666;
    font-size: 12px;
    line-height: 1.4;
}

.quick-tips {
    margin-top: 15px;
    padding: 15px;
    background: #fff3cd;
    border-radius: 8px;
    border-left: 4px solid #ffc107;
}

.quick-tips h4 {
    margin: 0 0 8px 0;
    color: #856404;
    font-size: 14px;
}

.quick-tips ul {
    margin: 0;
    padding-left: 15px;
    color: #856404;
    font-size: 12px;
}

.quick-tips li {
    margin: 4px 0;
}
</style>

<script>
function toggleHelp() {
    const panel = document.getElementById('helpPanel');
    panel.classList.toggle('visible');
}

function showGuide(type) {
    const messages = {
        login: '📝 登录说明：\\n• 学生端：用户名「小明」，密码任意\\n• 招聘端：用户名「小红」，密码任意\\n• 支持密码登录和短信验证码登录',
        role: '🔄 身份切换：\\n• 点击顶部「身份」按钮\\n• 选择学生或招聘者身份\\n• 系统会自动跳转到对应界面',
        job: '🏢 岗位功能：\\n• 学生：浏览、筛选、申请岗位\\n• 招聘者：发布、编辑、管理岗位\\n• 支持多种筛选条件和排序',
        chat: '💌 消息功能：\\n• 实时一对一沟通\\n• 消息已读状态显示\\n• 支持图片和文件传输'
    };
    
    alert(messages[type] || '功能指南即将推出');
}

// 点击外部关闭面板
document.addEventListener('click', function(e) {
    const panel = document.getElementById('helpPanel');
    const btn = document.querySelector('.help-btn');
    
    if (panel.classList.contains('visible') && 
        !panel.contains(e.target) && 
        e.target !== btn) {
        panel.classList.remove('visible');
    }
});

// ESC键关闭面板
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.getElementById('helpPanel').classList.remove('visible');
    }
});
</script>

</body>
</html>
